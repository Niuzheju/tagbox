var j=!0,s=!1;
(function(f,B,v){function C(h,c){function b(o){o=new D(o,c);o.a.insertBefore(k);a.b.push(o);k.val("");p(j);m.hide();r()}function e(o,c){o.remove();var b=a.b.indexOf(o);a.b.splice(b,1);o===i&&(i=v);r();p(j);c&&(-1===c?q(a.b[b-1]):1===c&&q(a.b[b]));t()}function r(){for(var o=[],b=0;b<a.b.length;b+=1)o.push(a.b[b].value);n.val(o.join(c.delimiter))}function q(a){i&&i.f();i!==a?(i=a,a.select()):i=v}function u(){i&&(i.f(),i=v)}function E(){var a=c.searchIn;"string"==typeof a&&(a=[a]);if(f.isArray(a)){for(var b={},
d=0;d<a.length;d+=1)b[a[d]]=10;return b}return a}function y(b){for(var c=0;c<a.b.length;c+=1)if(a.b[c].item===b)return j;return s}function t(){var a=c.items,b=[],d=k.val(),n=E();if(""===d&&!c.autoShow)m.hide();else{if(""!==d){for(var e=0;e<a.length;e+=1){var g={item:a[e],i:F(a[e],d,n)};0<g.i&&(c.allowDuplicates||!y(g.item))&&b.push(g)}b=b.sort(function(a,b){return b.i-a.i});for(e=0;e<b.length;e+=1)b[e]=b[e].item}else for(e=0;e<a.length;e+=1)(c.allowDuplicates||!y(a[e]))&&b.push(a[e]);m.s(b);m.r(d)}}
function p(b){a.k==k.val()&&b!==j||(u(),a.k=k.val(),g.text(a.k),k.width(0),k.width(Math.min(a.j.width()-16,Math.max(a.j.width()-k.offset().left+a.j.offset().left-16,g.width(),1))),m.t(d))}var a=this;a.b=[];var n=a.input=f(h).hide();a.options=c;var d=a.j=f('<div class="tagbox-wrapper" />').click(function(a){var b=f(a.target).closest("input, .tagbox-token, .tagbox-wrapper");b.is(".tagbox-token")?f(a.target).is("a")?e(b.data("token")):q(b.data("token")):u();k.focus()}).insertBefore(a.input),k=f('<input type="text" />').bind("keyup keydown blur update change",
p).bind("blur",function(){setTimeout(function(){a.l||m.hide()},50)}).bind("focus",t).bind("keydown",function(d){var n=k.val().length==k[0].selectionStart,g=0===k[0].selectionEnd;if(37===d.keyCode){if(i)return i===a.b[0]?u():q(a.b[a.b.indexOf(i)-1]),s;g&&a.b.length&&q(a.b[a.b.length-1])}if(39===d.keyCode){if(i)return i===a.b[a.b.length-1]?u():q(a.b[a.b.indexOf(i)+1]),s;n&&a.b.length&&q(a.b[0])}if(i&&(46===d.keyCode||8===d.keyCode))return e(i,8===d.keyCode?-1:1),s;if(8===d.keyCode&&g&&a.b.length)return q(a.b[a.b.length-
1]),s;if(k.val()){if(38===d.keyCode)return m.q(),s;if(40===d.keyCode)return m.p(),s;if(39==d.keyCode&&n||13==d.keyCode||9==d.keyCode){if(d=m.n())return b(d),s;if(c.allowNew)return b(c.createNew(k.val())),s}}else if(13==d.keyCode)return s;if(a.b.length===c.maxItems)return k.val(""),s;setTimeout(t,10)}).appendTo(d),g=f("<span />").appendTo(d).css({position:"absolute",left:-99999,width:"auto",display:"inline-block",whiteSpace:"nowrap",fontSize:n.css("fontSize"),fontFamily:n.css("fontFamily"),fontWeight:n.css("fontWeight"),
fontVariant:n.css("fontVariant"),letterSpacing:n.css("letterSpacing")}),m=a.u=new G(a,c);m.a.appendTo(c.dropdownContainer);if(n.val())for(var z=c.items,l=n.val().split(c.delimiter),A,w=0;w<l.length;w+=1){A=s;for(var x=0;x<z.length;x+=1)if(z[x][c.valueField]==l[w]){b(z[x]);A=j;break}!A&&c.allowNew&&b(c.createNew(l[w]))}p(j);f(B).bind("resize",function(){p(j)});a.m=b;var i}function D(h,c){var b=this.a=f('<div class="tagbox-token"><span></span><a>&times;</a></div>').data("token",this),e=c.tokenFormat;
"string"==typeof e?b.children("span").html(e.replace(/\{\{([^}]*)\}\}/g,function(b,c){return h[c]})):b.children("span").html(e(h));this.value=h[c.valueField];this.item=h;this.remove=function(){this.a.data("token",null);this.a.remove();this.a=this.item=null};this.select=function(){this.a.addClass("selected")};this.f=function(){this.a.removeClass("selected")}}function G(h,c){this.a=f('<div class="tagbox-dropdown"><div class="list"></div></div>').css({maxHeight:c.maxHeight}).hide();c.allowNew&&(this.h=
f('<div class="tagbox-item new-item" />').prependTo(this.a));this.t=function(b){this.a.offset();var c=b.offset(),h=this.a.parent().offset();this.a.parent().is("body")&&(h={top:0,left:0});this.a.css({top:c.top-h.top+b.height()+1,left:c.left-h.left,width:b.outerWidth()})};this.show=function(){this.a.show()};this.hide=function(){this.a.hide()};this.n=function(){if(this.d)return this.d.item};this.p=function(){this.selectedIndex===this.rows.length-1?c.allowNew||this.rows.length===0?this.c(-1):this.c(0):
this.c(this.selectedIndex+1)};this.q=function(){if(this.selectedIndex===0)c.allowNew?this.c(-1):this.c(this.rows.length-1);else{if(this.selectedIndex===-1)this.selectedIndex=this.rows.length;this.c(this.selectedIndex-1)}};this.c=function(b){this.d&&this.d.f();this.h&&this.h.removeClass("selected");typeof b!=="number"&&(b=this.rows.indexOf(b));if(b>=0){this.d=this.rows[b];this.d.select();this.o(this.d.a)}else{this.d=s;this.h&&this.h.addClass("selected")}this.selectedIndex=b};this.o=function(b){var c=
b.offset().top-this.a.offset().top-this.a.scrollTop();c<0?this.a.scrollTop(b.offset().top-this.a.offset().top):c>this.a.height()-b.height()&&this.a.scrollTop(c+this.a.scrollTop()-this.a.height()+b.height())};this.r=function(b){this.a.find(".new-item").text(c.newText.replace(/\{\{txt\}\}/g,b))};this.s=function(b){this.a.find(".list").empty();this.rows=[];if(b.length>0){for(var e=0;e<Math.min(b.length,c.maxListItems);e=e+1){var r=new H(b[e],c);r.a.appendTo(this.a.find(".list"));r.a.on("mouseover",function(b,
c){return function(){b.c(c)}}(this,r));r.a.on("mousedown",function(){h.l=j}).on("mouseup",function(){h.l=s});r.a.on("click",function(b){return function(){h.m(b)}}(b[e]));this.rows.push(r)}this.c(0)}else{c.allowNew||f('<div class="tagbox-item empty"/>').text(c.emptyText).appendTo(this.a.find(".list"));this.c(-1)}this.show()}}function H(h,c){this.a=f('<div class="tagbox-item" />');c.itemClass&&this.a.addClass(c.itemClass);this.item=h;var b=c.rowFormat;"string"==typeof b?this.a.html(b.replace(/\{\{([^}]*)\}\}/g,
function(b,c){return h[c]})):this.a.html(b(h));this.select=function(){this.a.addClass("selected")};this.f=function(){this.a.removeClass("selected")}}var F=function(){function h(a){return a.replace(/[\[\]\{\}\(\)\^\$\.\*\+\|]/g,function(a){return"\\"+a})}function c(a){return/[a-z]/.test(a)?q:/[A-Z]/.test(a)?f:/[0-9]/.test(a)?u:/[\/\-_\.]/.test(a)?v:y}function b(a,b,d){a=c(a);return t[a][c(b)]+0.4*t[a][c(d)]}function e(a,c,d){if(0===c.length)return 100*d/a.length;if(0===a.length||!a.slice(d).match(RegExp(("^.*"+
h(c.split("").join("~~K~~"))+".*$").split("~~K~~").join(".*"),"i")))return-1;for(var k=c.charAt(0),g=-1,m;d<a.length;d+=1)if(a.charAt(d).toLowerCase()===k.toLowerCase()){var f=e(a.substr(d),c.slice(1),1);if(-1!=f){var l=400/Math.max(1,d);0===a.substr(d).toLowerCase().indexOf(c.toLowerCase())&&(l+=3*c.length*c.length);l+=b(a.charAt(d),0===d?"/":a.charAt(d-1),d===a.length-1?"/":a.charAt(d+1));l+=f;if(l>g){g=l;m=[d];f=f.g||[];for(l=0;l<f.length;l+=1)m.push(f[l]+d)}}}return{e:g,valueOf:function(){return this.e},
g:m}}var f=0,q=1,u=2,v=3,y=4,t=[[0,240,120,240,220],[20,0,20,120,120],[140,140,0,140,140],[120,120,120,0,120],[120,120,120,160,0]],p=function(a,b){var c=RegExp("["+a+"]","g"),e={},g;lookup=function(a){return e[a]||a};for(g=0;g<a.length;g+=1)e[a.charAt(g)]=b.charAt(g);return function(a){return a.replace(c,lookup)}}("\u00e0\u00e1\u00e2\u00e3\u00e4\u00e7\u00e8\u00e9\u00ea\u00eb\u00ec\u00ed\u00ee\u00ef\u00f1\u00f2\u00f3\u00f4\u00f5\u00f6\u00f9\u00fa\u00fb\u00fc\u00fd\u00ff\u00c0\u00c1\u00c2\u00c3\u00c4\u00c7\u00c8\u00c9\u00ca\u00cb\u00cc\u00cd\u00ce\u00cf\u00d1\u00d2\u00d3\u00d4\u00d5\u00d6\u00d9\u00da\u00db\u00dc\u00dd",
"aaaaaceeeeiiiinooooouuuuyyAAAAACEEEEIIIINOOOOOUUUUY");return function(a,b,c){if("string"==typeof a)return e(p(a),p(b),0);var f={e:0,valueOf:function(){return this.e},g:{}},g;for(g in c)if(c.hasOwnProperty(g)&&a.hasOwnProperty(g)){var h=e(p(a[g]),p(b),0);f.e+=c[g]*h;f.g[g]=0<h?h.g:[]}return f}}();f.fn.tagbox=function(h){var c=f.extend({},{maxHeight:200,maxListItems:20,rowFormat:"{{name}}",tokenFormat:"{{name}}",valueField:"name",delimiter:",",allowDuplicates:s,createNew:function(b){return{name:b}},
allowNew:s,newText:"{{txt}}",emptyText:"Not Found",dropdownContainer:"body",maxItems:-1,autoShow:s},h);return this.each(function(){var b=new C(this,c);f(this).data("tagbox",b)})}})(jQuery,window);
