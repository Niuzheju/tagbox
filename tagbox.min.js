var k=!0,q=!1;
(function(i,B,t){function C(d,b){function a(o){o=new D(o,b);o.a.insertBefore(h);c.b.push(o);h.val("");g(k);l.hide();p()}function e(o,b){o.remove();var a=c.b.indexOf(o);c.b.splice(a,1);o===j&&(j=t);p();g(k);b&&(-1===b?n(c.b[a-1]):1===b&&n(c.b[a]));r()}function p(){for(var o=[],a=0;a<c.b.length;a+=1)o.push(c.b[a].value);f.val(o.join(b.delimiter))}function n(c){j&&j.f();j!==c?(j=c,c.select()):j=t}function s(){j&&(j.f(),j=t)}function E(){var c=b.searchIn;"string"==typeof c&&(c=[c]);if(i.isArray(c)){for(var a={},
g=0;g<c.length;g+=1)a[c[g]]=10;return a}return c}function w(a){for(var b=0;b<c.b.length;b+=1)if(c.b[b].item===a)return k;return q}function r(){var c=b.items,a=[],g=h.val(),f=E();if(""===g&&!b.autoShow)l.hide();else{if(""!==g){for(var e=0;e<c.length;e+=1){var d={item:c[e],i:F(c[e],g,f)};0<d.i&&(b.allowDuplicates||!w(d.item))&&a.push(d)}a=a.sort(function(c,a){return a.i-c.i});for(e=0;e<a.length;e+=1)a[e]=a[e].item}else for(e=0;e<c.length;e+=1)(b.allowDuplicates||!w(c[e]))&&a.push(c[e]);l.s(a);l.r(g)}}
function g(a){c.k==h.val()&&a!==k||(s(),c.k=h.val(),A.text(c.k),h.width(0),h.width(Math.min(c.j.width()-16,Math.max(c.j.width()-h.offset().left+c.j.offset().left-16,A.width(),1))),l.t(x))}var c=this;c.b=[];var f=c.input=i(d).hide();c.options=b;var x=c.j=i('<div class="tagbox-wrapper" />').click(function(c){var a=i(c.target).closest("input, .tagbox-token, .tagbox-wrapper");a.is(".tagbox-token")?i(c.target).is("a")?e(a.data("token")):n(a.data("token")):s();h.focus()}).insertBefore(c.input),h=i('<input type="text" />').bind("keyup keydown blur update change",
g).bind("blur",function(){setTimeout(function(){c.l||l.hide()},50)}).bind("focus",r).bind("keydown",function(g){var f=h.val().length==h[0].selectionStart,d=0===h[0].selectionEnd;if(37===g.keyCode){if(j)return j===c.b[0]?s():n(c.b[c.b.indexOf(j)-1]),q;d&&c.b.length&&n(c.b[c.b.length-1])}if(39===g.keyCode){if(j)return j===c.b[c.b.length-1]?s():n(c.b[c.b.indexOf(j)+1]),q;f&&c.b.length&&n(c.b[0])}if(j&&(46===g.keyCode||8===g.keyCode))return e(j,8===g.keyCode?-1:1),q;if(8===g.keyCode&&d&&c.b.length)return n(c.b[c.b.length-
1]),q;if(h.val()){if(38===g.keyCode)return l.q(),q;if(40===g.keyCode)return l.p(),q;if(39==g.keyCode&&f||13==g.keyCode||9==g.keyCode){if(g=l.n())return a(g),q;if(b.allowNew)return a(b.createNew(h.val())),q}}else if(13==g.keyCode)return q;if(c.b.length===b.maxItems)return h.val(""),q;setTimeout(r,10)}).appendTo(x),A=i("<span />").appendTo(x).css({position:"absolute",left:-99999,width:"auto",display:"inline-block",whiteSpace:"nowrap",fontSize:f.css("fontSize"),fontFamily:f.css("fontFamily"),fontWeight:f.css("fontWeight"),
fontVariant:f.css("fontVariant"),letterSpacing:f.css("letterSpacing")}),l=c.u=new G(c,b);l.a.appendTo(b.dropdownContainer);if(f.val())for(var m=b.items,y=f.val().split(b.delimiter),z,u=0;u<y.length;u+=1){z=q;for(var v=0;v<m.length;v+=1)if(m[v][b.valueField]==y[u]){a(m[v]);z=k;break}!z&&b.allowNew&&a(b.createNew(y[u]))}g(k);i(B).bind("resize",function(){g(k)});c.m=a;var j}function D(d,b){var a=this.a=i('<div class="tagbox-token"><span></span><a>&times;</a></div>').data("token",this),e=b.tokenFormat;
"string"==typeof e?a.children("span").html(e.replace(/\{\{([^}]*)\}\}/g,function(a,b){return d[b]})):a.children("span").html(e(d));this.value=d[b.valueField];this.item=d;this.remove=function(){this.a.data("token",null);this.a.remove();this.a=this.item=null};this.select=function(){this.a.addClass("selected")};this.f=function(){this.a.removeClass("selected")}}function G(d,b){this.a=i('<div class="tagbox-dropdown"><div class="list"></div></div>').css({maxHeight:b.maxHeight}).hide();b.allowNew&&(this.h=
i('<div class="tagbox-item new-item" />').prependTo(this.a));this.t=function(a){this.a.offset();var b=a.offset(),d=this.a.parent().offset();this.a.parent().is("body")&&(d={top:0,left:0});this.a.css({top:b.top-d.top+a.height()+1,left:b.left-d.left,width:a.outerWidth()})};this.show=function(){this.a.show()};this.hide=function(){this.a.hide()};this.n=function(){if(this.d)return this.d.item};this.p=function(){this.selectedIndex===this.rows.length-1?b.allowNew||this.rows.length===0?this.c(-1):this.c(0):
this.c(this.selectedIndex+1)};this.q=function(){if(this.selectedIndex===0)b.allowNew?this.c(-1):this.c(this.rows.length-1);else{if(this.selectedIndex===-1)this.selectedIndex=this.rows.length;this.c(this.selectedIndex-1)}};this.c=function(a){this.d&&this.d.f();this.h&&this.h.removeClass("selected");typeof a!=="number"&&(a=this.rows.indexOf(a));if(a>=0){this.d=this.rows[a];this.d.select();this.o(this.d.a)}else{this.d=q;this.h&&this.h.addClass("selected")}this.selectedIndex=a};this.o=function(a){var b=
a.offset().top-this.a.offset().top-this.a.scrollTop();b<0?this.a.scrollTop(a.offset().top-this.a.offset().top):b>this.a.height()-a.height()&&this.a.scrollTop(b+this.a.scrollTop()-this.a.height()+a.height())};this.r=function(a){this.a.find(".new-item").text(b.newText.replace(/\{\{txt\}\}/g,a))};this.s=function(a){this.a.find(".list").empty();this.rows=[];if(a.length>0){for(var e=0;e<Math.min(a.length,b.maxListItems);e=e+1){var p=new H(a[e],b);p.a.appendTo(this.a.find(".list"));p.a.on("mouseover",function(a,
b){return function(){a.c(b)}}(this,p));p.a.on("mousedown",function(){d.l=k}).on("mouseup",function(){d.l=q});p.a.on("click",function(a){return function(){d.m(a)}}(a[e]));this.rows.push(p)}this.c(0)}else{b.allowNew||i('<div class="tagbox-item empty"/>').text(b.emptyText).appendTo(this.a.find(".list"));this.c(-1)}this.show()}}function H(d,b){this.a=i('<div class="tagbox-item" />');b.itemClass&&this.a.addClass(b.itemClass);this.item=d;var a=b.rowFormat;"string"==typeof a?this.a.html(a.replace(/\{\{([^}]*)\}\}/g,
function(a,b){return d[b]})):this.a.html(a(d));this.select=function(){this.a.addClass("selected")};this.f=function(){this.a.removeClass("selected")}}var F=function(){function d(a){return a.replace(/[\[\]\{\}\(\)\^\$\.\*\+\|]/g,function(a){return"\\"+a})}function b(a){return/[a-z]/.test(a)?n:/[A-Z]/.test(a)?i:/[0-9]/.test(a)?s:/[\/\-_\.]/.test(a)?t:w}function a(a,c,f){a=b(a);return r[a][b(c)]+0.4*r[a][b(f)]}function e(b,c,f){if(0===c.length)return 100*f/b.length;if(0===b.length||!b.slice(f).match(RegExp(("^.*"+
d(c.split("").join("~~K~~"))+".*$").split("~~K~~").join(".*"),"i")))return-1;for(var i=c.charAt(0),h=-1,n;f<b.length;f+=1)if(b.charAt(f).toLowerCase()===i.toLowerCase()){var l=e(b.substr(f),c.slice(1),1);if(-1!=l){var m=400/Math.max(1,f);0===b.substr(f).toLowerCase().indexOf(c.toLowerCase())&&(m+=3*c.length*c.length);m+=a(b.charAt(f),0===f?"/":b.charAt(f-1),f===b.length-1?"/":b.charAt(f+1));m+=l;if(m>h){h=m;n=[f];l=l.g||[];for(m=0;m<l.length;m+=1)n.push(l[m]+f)}}}return{e:h,valueOf:function(){return this.e},
g:n}}var i=0,n=1,s=2,t=3,w=4,r=[[0,240,120,240,220],[20,0,20,120,120],[140,140,0,140,140],[120,120,120,0,120],[120,120,120,160,0]];return function(a,c,b){if("string"==typeof a)return e(a,c,0);var d={e:0,valueOf:function(){return this.e},g:{}},h;for(h in b)if(b.hasOwnProperty(h)&&a.hasOwnProperty(h)){var i=e(a[h],c,0);d.e+=b[h]*i;d.g[h]=0<i?i.g:[]}return d}}();i.fn.tagbox=function(d){var b=i.extend({},{maxHeight:200,maxListItems:20,rowFormat:"{{name}}",tokenFormat:"{{name}}",valueField:"name",delimiter:",",
allowDuplicates:q,createNew:function(a){return{name:a}},allowNew:q,newText:"{{txt}}",emptyText:"Not Found",dropdownContainer:"body",maxItems:-1,autoShow:q},d);return this.each(function(){var a=new C(this,b);i(this).data("tagbox",a)})}})(jQuery,window);
