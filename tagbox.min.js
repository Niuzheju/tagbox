var p=!0,v=!1;
(function(h,F,y){function z(g,e){function c(s){s=new G(s,e);s.b.insertBefore(m);s.b.css("maxWidth",a.c.width());a.a.push(s);z&&m.val("");q(p);r.hide();m.focus();f()}function l(s,b){s.remove();var e=a.a.indexOf(s);a.a.splice(e,1);s===n&&(n=y);f();q(p);b&&(-1===b?k(a.a[e-1]):1===b&&k(a.a[e]));o()}function f(){for(var s=[],d=0;d<a.a.length;d+=1)s.push(a.a[d].value);b.val(s.join(e.delimiter))}function k(a){n&&n.e();n!==a?(n=a,a.select()):n=y}function t(){n&&(n.e(),n=y)}function u(){var a=e.searchIn;"string"==
typeof a&&(a=[a]);if(h.isArray(a)){for(var b={},d=0;d<a.length;d+=1)b[a[d]]=10;return b}return a}function i(b){for(var d=0;d<a.a.length;d+=1)if(a.a[d].item===b)return p;return v}function o(){var b=e.items,c=[],g=m.val(),f=u();a.c.removeClass("invalid");if(a.a.length===e.maxItems)r.hide(),m.removeAttr("placeholder");else if(m.attr("placeholder",D),""===g&&!e.autoShow)r.hide();else{if(""!==g){for(var j=0;j<b.length;j+=1){var k={item:b[j],i:H(b[j],g,f)};0<k.i&&(e.allowDuplicates||!i(k.item))&&c.push(k)}c=
c.sort(function(a,b){return b.i-a.i});for(j=0;j<c.length;j+=1)c[j]=c[j].item}else for(j=0;j<b.length;j+=1)(e.allowDuplicates||!i(b[j]))&&c.push(b[j]);r.q(c);r.p(g);r.l(d)}}function q(b){a.k==m.val()&&b!==p||(t(),a.k=m.val(),E.text(a.k),m.width(0),m.width(Math.min(a.c.width()-16,Math.max(a.c.width()-m.offset().left+a.c.offset().left+16,E.width(),1))),r.l(d))}var a=this;a.a=[];var b=a.input=h(g).hide();a.options=e;var d=a.c=h('<div class="tagbox-wrapper" />').click(function(a){var b=h(a.target).closest("input, .tagbox-token, .tagbox-wrapper");
b.is(".tagbox-token")?h(a.target).is("a")?l(b.data("token")):k(b.data("token")):t();m.focus()}).insertBefore(a.input);b.on("invalid",function(b){b.preventDefault();a.c.addClass("invalid")});var D=b.attr("placeholder"),m=h('<input type="text" />').attr({autocomplete:b.attr("autocomplete"),spellcheck:b.attr("spellcheck"),autocapitalize:b.attr("autocapitalize"),placeholder:D}).on("keyup keydown blur update change",q).on("keypress",function(a){if(13===a.keyCode&&m.val())return a.preventDefault(),v}).on("blur",
function(){setTimeout(function(){a.f||r.hide();d.removeClass("focus")},50)}).on("keydown",function(b){var d=m.val().length==m[0].selectionStart,g=0===m[0].selectionEnd,f=b.keyCode,j=v;if(b.ctrlKey||b.metaKey)j=p;if(37===f){if(n)return n===a.a[0]?t():k(a.a[a.a.indexOf(n)-1]),j;g&&a.a.length&&k(a.a[a.a.length-1])}if(39===f){if(n)return n===a.a[a.a.length-1]?t():k(a.a[a.a.indexOf(n)+1]),j;d&&a.a.length&&k(a.a[0])}if(n&&(46===f||8===f))return l(n,8===f?-1:1),j;if(8===f&&g&&a.a.length)return k(a.a[a.a.length-
1]),j;if(r.visible){if(38===f)return r.o(),j;if(40===f)return r.n(),j;if(39==f&&d||13==f||9==f){if(d=r.m())return c(d),j;if(e.allowNew)return c(e.createNew(m.val())),j}}else if(13==f)return j;if(a.a.length===e.maxItems&&9!=b.keyCode)return m.val(""),j;setTimeout(o,10)}).on("focus",function(){d.addClass("focus");o()}).appendTo(d),E=h("<span />").appendTo(d).css({position:"absolute",left:-1E5,width:"auto",display:"inline-block",whiteSpace:"nowrap",fontSize:b.css("fontSize"),fontFamily:b.css("fontFamily"),
fontWeight:b.css("fontWeight"),fontVariant:b.css("fontVariant"),letterSpacing:b.css("letterSpacing")}),r=a.r=new I(a,e);r.b.appendTo(e.dropdownContainer);if(b.val())for(var A=e.items,B=b.val().split(e.delimiter),C,w=0;w<B.length;w+=1){C=v;for(var x=0;x<A.length;x+=1)if(A[x][e.valueField]==B[w]){c(A[x]);C=p;break}!C&&e.allowNew&&c(e.createNew(B[w]))}var z=p;q(p);h(F).on("resize",function(){q(p)});a.j=c;var n}function G(g,e){var c=this,l=c.b=h('<div class="tagbox-token"><span></span><a>&times;</a></div>').data("token",
c),f=e.tokenFormat;c.value="string"==typeof g?g:g[e.valueField];c.item=g;"string"==typeof f?("string"==typeof g&&(g={value:g}),l.children("span").html(f.replace(/\{\{([^}]*)\}\}/g,function(e,c){return g[c]}))):l.children("span").html(f(g));c.remove=function(){l.data("token",null);l.remove();c.item=null;c.b=null};c.select=function(){l.addClass("selected")};c.e=function(){l.removeClass("selected")}}function I(g,e){function c(a,b){k&&k.e();o&&o.removeClass("selected");"number"!==typeof a&&(a=u.indexOf(a));
0<=a?(k=u[a],k.select(),clearTimeout(q),b?q=setTimeout(function(){l(k.b)},80):l(k.b)):(k=v,o&&o.addClass("selected"));t=a}function l(a){var b=a.offset().top-i.offset().top;0>b?i.scrollTop(b+i.scrollTop()):b>i.innerHeight()-a.outerHeight()&&i.scrollTop(b+i.scrollTop()-i.innerHeight()+a.outerHeight())}var f=this,k,t,u,i=f.b=h('<div class="tagbox-dropdown"><div class="list"></div></div>').css({maxHeight:e.maxHeight}).hide();if(e.allowNew)var o=h('<div class="tagbox-item new-item" />').prependTo(i).on("mousedown",
function(){g.f=p}).on("mouseup",function(){g.f=v}).on("click",function(){g.j(e.createNew(f.h))});f.l=function(a){i.offset();var b=a.offset(),d=i.parent().offset();i.parent().is("body")&&(d={top:0,left:0});i.css({top:b.top-d.top+a.height()+1,left:b.left-d.left,width:a.outerWidth()})};f.show=function(){i.show();f.visible=p};f.hide=function(){i.hide();f.visible=v};f.m=function(){if(k)return k.item};f.n=function(){t===u.length-1?e.allowNew&&f.h||0===u.length?c(-1):c(0):c(t+1)};f.o=function(){0===t?e.allowNew&&
f.h?c(-1):c(u.length-1):(-1===t&&(t=u.length),c(t-1))};var q;f.p=function(a){o&&((f.h=a)?o.show().text(e.newText.replace(/\{\{txt\}\}/g,a)):o.hide())};f.q=function(a){i.find(".list").empty();u=[];if(0<a.length){for(var b=0;b<Math.min(a.length,e.maxListItems);b+=1){var d=new J(a[b],e);d.b.appendTo(i.find(".list"));d.b.on("mouseover",function(a){return function(){c(a,p)}}(d));d.b.on("mousedown",function(){g.f=p}).on("mouseup",function(){g.f=v});d.b.on("click",function(a){return function(){g.j(a)}}(a[b]));
u.push(d)}c(0)}else e.allowNew||h('<div class="tagbox-item empty"/>').text(e.emptyText).appendTo(i.find(".list")),c(-1);f.show()}}function J(g,e){var c=this.b=h('<div class="tagbox-item" />');e.itemClass&&c.addClass(e.itemClass);this.item=g;var l=e.rowFormat;"string"==typeof l?("string"==typeof g&&(g={value:g}),c.html(l.replace(/\{\{([^}]*)\}\}/g,function(e,c){return g[c]}))):c.html(l(g));this.select=function(){c.addClass("selected")};this.e=function(){c.removeClass("selected")}}var H=function(){function g(a){return a.replace(/[\[\]\{\}\(\)\^\$\.\*\+\|]/g,
function(a){return"\\"+a})}function e(a){return/[a-z]/.test(a)?k:/[A-Z]/.test(a)?f:/[0-9]/.test(a)?h:/[\/\-_\.]/.test(a)?u:i}function c(a,b,d){a=e(a);return o[a][e(b)]+0.4*o[a][e(d)]}function l(a,b,d){if(0===b.length)return 100*d/a.length;if(0===a.length||!a.slice(d).match(RegExp(("^.*"+g(b.split("").join("~~K~~"))+".*$").split("~~K~~").join(".*"),"i")))return-1;for(var e=b.charAt(0),f=-1,k;d<a.length;d+=1)if(a.charAt(d).toLowerCase()===e.toLowerCase()){var i=l(a.substr(d),b.slice(1),1);if(-1!=i){var h=
400/Math.max(1,d);0===a.substr(d).toLowerCase().indexOf(b.toLowerCase())&&(h+=3*b.length*b.length);h+=c(a.charAt(d),0===d?"/":a.charAt(d-1),d===a.length-1?"/":a.charAt(d+1));h+=i;if(h>f){f=h;k=[d];i=i.g||[];for(h=0;h<i.length;h+=1)k.push(i[h]+d)}}}return{d:f,valueOf:function(){return this.d},g:k}}var f=0,k=1,h=2,u=3,i=4,o=[[0,240,120,240,220],[20,0,20,120,120],[140,140,0,140,140],[120,120,120,0,120],[120,120,120,160,0]],q=function(a,b){var d=RegExp("["+a+"]","g"),e={},c;lookup=function(a){return e[a]||
a};for(c=0;c<a.length;c+=1)e[a.charAt(c)]=b.charAt(c);return function(a){return a.replace(d,lookup)}}("\u00e0\u00e1\u00e2\u00e3\u00e4\u00e7\u00e8\u00e9\u00ea\u00eb\u00ec\u00ed\u00ee\u00ef\u00f1\u00f2\u00f3\u00f4\u00f5\u00f6\u00f9\u00fa\u00fb\u00fc\u00fd\u00ff\u00c0\u00c1\u00c2\u00c3\u00c4\u00c7\u00c8\u00c9\u00ca\u00cb\u00cc\u00cd\u00ce\u00cf\u00d1\u00d2\u00d3\u00d4\u00d5\u00d6\u00d9\u00da\u00db\u00dc\u00dd","aaaaaceeeeiiiinooooouuuuyyAAAAACEEEEIIIINOOOOOUUUUY");return function(a,b,d){if("string"==
typeof a)return l(q(a),q(b),0);var c={d:0,valueOf:function(){return this.d},g:{}},e;for(e in d)if(d.hasOwnProperty(e)&&a.hasOwnProperty(e)){var f=l(q(a[e]),q(b),0);c.d+=d[e]*f;c.g[e]=0<f?f.g:[]}return c}}();h.fn.tagbox=function(g){var e=h.extend({},{maxHeight:200,maxListItems:20,rowFormat:"{{value}}",tokenFormat:"{{value}}",valueField:"value",delimiter:",",allowDuplicates:v,createNew:function(c){return{value:c}},allowNew:v,newText:"{{txt}}",emptyText:"Not Found",dropdownContainer:"body",maxItems:-1,
autoShow:v},g);return this.each(function(){if(!h(this).data("tagbox")){var c=new z(this,e);h(this).data("tagbox",c)}})}})(jQuery,window);
