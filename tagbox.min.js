var m=!0,t=!1;
(function(j,D,x){function y(c,e){function f(r){r=new E(r,e);r.b.insertBefore(n);a.a.push(r);y&&n.val("");o(m);u.hide();g()}function k(r,e){r.remove();var b=a.a.indexOf(r);a.a.splice(b,1);r===l&&(l=x);g();o(m);e&&(-1===e?h(a.a[b-1]):1===e&&h(a.a[b]));s()}function g(){for(var r=[],d=0;d<a.a.length;d+=1)r.push(a.a[d].value);b.val(r.join(e.delimiter))}function h(a){l&&l.d();l!==a?(l=a,a.select()):l=x}function p(){l&&(l.d(),l=x)}function q(){var a=e.searchIn;"string"==typeof a&&(a=[a]);if(j.isArray(a)){for(var b={},
d=0;d<a.length;d+=1)b[a[d]]=10;return b}return a}function i(d){for(var b=0;b<a.a.length;b+=1)if(a.a[b].item===d)return m;return t}function s(){var a=e.items,b=[],d=n.val(),f=q();if(""===d&&!e.autoShow)u.hide();else{if(""!==d){for(var c=0;c<a.length;c+=1){var h={item:a[c],f:F(a[c],d,f)};0<h.f&&(e.allowDuplicates||!i(h.item))&&b.push(h)}b=b.sort(function(a,b){return b.f-a.f});for(c=0;c<b.length;c+=1)b[c]=b[c].item}else for(c=0;c<a.length;c+=1)(e.allowDuplicates||!i(a[c]))&&b.push(a[c]);u.o(b);u.n(d)}}
function o(b){a.h==n.val()&&b!==m||(p(),a.h=n.val(),C.text(a.h),n.width(0),n.width(Math.min(a.g.width()-16,Math.max(a.g.width()-n.offset().left+a.g.offset().left+16,C.width(),1))),u.p(d))}var a=this;a.a=[];var b=a.input=j(c).hide();a.options=e;var d=a.g=j('<div class="tagbox-wrapper" />').click(function(a){var b=j(a.target).closest("input, .tagbox-token, .tagbox-wrapper");b.is(".tagbox-token")?j(a.target).is("a")?k(b.data("token")):h(b.data("token")):p();n.focus()}).insertBefore(a.input),n=j('<input type="text" />').on("keyup keydown blur update change",
o).on("blur",function(){setTimeout(function(){a.i||u.hide()},50)}).on("focus",s).on("keydown",function(b){var d=n.val().length==n[0].selectionStart,c=0===n[0].selectionEnd,b=b.keyCode;if(37===b){if(l)return l===a.a[0]?p():h(a.a[a.a.indexOf(l)-1]),t;c&&a.a.length&&h(a.a[a.a.length-1])}if(39===b){if(l)return l===a.a[a.a.length-1]?p():h(a.a[a.a.indexOf(l)+1]),t;d&&a.a.length&&h(a.a[0])}if(l&&(46===b||8===b))return k(l,8===b?-1:1),t;if(8===b&&c&&a.a.length)return h(a.a[a.a.length-1]),t;if(n.val()){if(38===
b)return u.m(),t;if(40===b)return u.l(),t;if(39==b&&d||13==b||9==b){if(d=u.k())return f(d),t;if(e.allowNew)return f(e.createNew(n.val())),t}}else if(13==b)return t;if(a.a.length===e.maxItems)return n.val(""),t;setTimeout(s,10)}).appendTo(d),C=j("<span />").appendTo(d).css({position:"absolute",left:-1E5,width:"auto",display:"inline-block",whiteSpace:"nowrap",fontSize:b.css("fontSize"),fontFamily:b.css("fontFamily"),fontWeight:b.css("fontWeight"),fontVariant:b.css("fontVariant"),letterSpacing:b.css("letterSpacing")}),
u=a.q=new G(a,e);u.b.appendTo(e.dropdownContainer);if(b.val())for(var z=e.items,A=b.val().split(e.delimiter),B,v=0;v<A.length;v+=1){B=t;for(var w=0;w<z.length;w+=1)if(z[w][e.valueField]==A[v]){f(z[w]);B=m;break}!B&&e.allowNew&&f(e.createNew(A[v]))}var y=m;o(m);j(D).on("resize",function(){o(m)});a.j=f;var l}function E(c,e){var f=this,k=f.b=j('<div class="tagbox-token"><span></span><a>&times;</a></div>').data("token",f),g=e.tokenFormat;f.value="string"==typeof c?c:c[e.valueField];f.item=c;"string"==
typeof g?("string"==typeof c&&(c={value:c}),k.children("span").html(g.replace(/\{\{([^}]*)\}\}/g,function(e,f){return c[f]}))):k.children("span").html(g(c));f.remove=function(){k.data("token",null);k.remove();f.item=null;f.b=null};f.select=function(){k.addClass("selected")};f.d=function(){k.removeClass("selected")}}function G(c,e){function f(a,b){h&&h.d();s&&s.removeClass("selected");"number"!==typeof a&&(a=q.indexOf(a));0<=a?(h=q[a],h.select(),clearTimeout(o),b?o=setTimeout(function(){k(h.b)},80):
k(h.b)):(h=t,s&&s.addClass("selected"));p=a}function k(a){var b=a.offset().top-i.offset().top;0>b?i.scrollTop(b+i.scrollTop()):b>i.innerHeight()-a.outerHeight()&&i.scrollTop(b+i.scrollTop()-i.innerHeight()+a.outerHeight())}var g=this,h,p,q,i=g.b=j('<div class="tagbox-dropdown"><div class="list"></div></div>').css({maxHeight:e.maxHeight}).hide();if(e.allowNew)var s=j('<div class="tagbox-item new-item" />').prependTo(i);g.p=function(a){i.offset();var b=a.offset(),d=i.parent().offset();i.parent().is("body")&&
(d={top:0,left:0});i.css({top:b.top-d.top+a.height()+1,left:b.left-d.left,width:a.outerWidth()})};g.show=function(){i.show()};g.hide=function(){i.hide()};g.k=function(){if(h)return h.item};g.l=function(){p===q.length-1?e.allowNew||0===q.length?f(-1):f(0):f(p+1)};g.m=function(){0===p?e.allowNew?f(-1):f(q.length-1):(-1===p&&(p=q.length),f(p-1))};var o;g.n=function(a){i.find(".new-item").text(e.newText.replace(/\{\{txt\}\}/g,a))};g.o=function(a){i.find(".list").empty();q=[];if(0<a.length){for(var b=
0;b<Math.min(a.length,e.maxListItems);b+=1){var d=new H(a[b],e);d.b.appendTo(i.find(".list"));d.b.on("mouseover",function(a){return function(){f(a,m)}}(d));d.b.on("mousedown",function(){c.i=m}).on("mouseup",function(){c.i=t});d.b.on("click",function(a){return function(){c.j(a)}}(a[b]));q.push(d)}f(0)}else e.allowNew||j('<div class="tagbox-item empty"/>').text(e.emptyText).appendTo(i.find(".list")),f(-1);g.show()}}function H(c,e){var f=this.b=j('<div class="tagbox-item" />');e.itemClass&&f.addClass(e.itemClass);
this.item=c;var k=e.rowFormat;"string"==typeof k?("string"==typeof c&&(c={value:c}),f.html(k.replace(/\{\{([^}]*)\}\}/g,function(e,f){return c[f]}))):f.html(k(c));this.select=function(){f.addClass("selected")};this.d=function(){f.removeClass("selected")}}var F=function(){function c(a){return a.replace(/[\[\]\{\}\(\)\^\$\.\*\+\|]/g,function(a){return"\\"+a})}function e(a){return/[a-z]/.test(a)?h:/[A-Z]/.test(a)?g:/[0-9]/.test(a)?j:/[\/\-_\.]/.test(a)?q:i}function f(a,b,d){a=e(a);return s[a][e(b)]+
0.4*s[a][e(d)]}function k(a,b,d){if(0===b.length)return 100*d/a.length;if(0===a.length||!a.slice(d).match(RegExp(("^.*"+c(b.split("").join("~~K~~"))+".*$").split("~~K~~").join(".*"),"i")))return-1;for(var e=b.charAt(0),h=-1,i;d<a.length;d+=1)if(a.charAt(d).toLowerCase()===e.toLowerCase()){var j=k(a.substr(d),b.slice(1),1);if(-1!=j){var g=400/Math.max(1,d);0===a.substr(d).toLowerCase().indexOf(b.toLowerCase())&&(g+=3*b.length*b.length);g+=f(a.charAt(d),0===d?"/":a.charAt(d-1),d===a.length-1?"/":a.charAt(d+
1));g+=j;if(g>h){h=g;i=[d];j=j.e||[];for(g=0;g<j.length;g+=1)i.push(j[g]+d)}}}return{c:h,valueOf:function(){return this.c},e:i}}var g=0,h=1,j=2,q=3,i=4,s=[[0,240,120,240,220],[20,0,20,120,120],[140,140,0,140,140],[120,120,120,0,120],[120,120,120,160,0]],o=function(a,b){var d=RegExp("["+a+"]","g"),e={},c;lookup=function(a){return e[a]||a};for(c=0;c<a.length;c+=1)e[a.charAt(c)]=b.charAt(c);return function(a){return a.replace(d,lookup)}}("\u00e0\u00e1\u00e2\u00e3\u00e4\u00e7\u00e8\u00e9\u00ea\u00eb\u00ec\u00ed\u00ee\u00ef\u00f1\u00f2\u00f3\u00f4\u00f5\u00f6\u00f9\u00fa\u00fb\u00fc\u00fd\u00ff\u00c0\u00c1\u00c2\u00c3\u00c4\u00c7\u00c8\u00c9\u00ca\u00cb\u00cc\u00cd\u00ce\u00cf\u00d1\u00d2\u00d3\u00d4\u00d5\u00d6\u00d9\u00da\u00db\u00dc\u00dd",
"aaaaaceeeeiiiinooooouuuuyyAAAAACEEEEIIIINOOOOOUUUUY");return function(a,b,d){if("string"==typeof a)return k(o(a),o(b),0);var c={c:0,valueOf:function(){return this.c},e:{}},e;for(e in d)if(d.hasOwnProperty(e)&&a.hasOwnProperty(e)){var f=k(o(a[e]),o(b),0);c.c+=d[e]*f;c.e[e]=0<f?f.e:[]}return c}}();j.fn.tagbox=function(c){var e=j.extend({},{maxHeight:200,maxListItems:20,rowFormat:"{{name}}",tokenFormat:"{{name}}",valueField:"name",delimiter:",",allowDuplicates:t,createNew:function(c){return{name:c}},
allowNew:t,newText:"{{txt}}",emptyText:"Not Found",dropdownContainer:"body",maxItems:-1,autoShow:t},c);return this.each(function(){if(!j(this).data("tagbox")){var c=new y(this,e);j(this).data("tagbox",c)}})}})(jQuery,window);
