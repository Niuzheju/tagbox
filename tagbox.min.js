var l=!0,t=!1;
(function(h,C,w){function x(i,c){function e(b){b=new D(b,c);b.b.insertBefore(n);b.b.css("maxWidth",a.f.width());a.a.push(b);x&&n.val("");o(l);r.hide();g()}function k(b,c){b.remove();var d=a.a.indexOf(b);a.a.splice(d,1);b===m&&(m=w);g();o(l);c&&(-1===c?f(a.a[d-1]):1===c&&f(a.a[d]));s()}function g(){for(var d=[],e=0;e<a.a.length;e+=1)d.push(a.a[e].value);b.val(d.join(c.delimiter))}function f(a){m&&m.d();m!==a?(m=a,a.select()):m=w}function p(){m&&(m.d(),m=w)}function q(){var a=c.searchIn;"string"==typeof a&&
(a=[a]);if(h.isArray(a)){for(var b={},d=0;d<a.length;d+=1)b[a[d]]=10;return b}return a}function j(b){for(var d=0;d<a.a.length;d+=1)if(a.a[d].item===b)return l;return t}function s(){var a=c.items,b=[],e=n.val(),i=q();if(""===e&&!c.autoShow)r.hide();else{if(""!==e){for(var f=0;f<a.length;f+=1){var g={item:a[f],g:E(a[f],e,i)};0<g.g&&(c.allowDuplicates||!j(g.item))&&b.push(g)}b=b.sort(function(a,b){return b.g-a.g});for(f=0;f<b.length;f+=1)b[f]=b[f].item}else for(f=0;f<a.length;f+=1)(c.allowDuplicates||
!j(a[f]))&&b.push(a[f]);r.p(b);r.o(e);r.j(d)}}function o(b){a.h==n.val()&&b!==l||(p(),a.h=n.val(),B.text(a.h),n.width(0),n.width(Math.min(a.f.width()-16,Math.max(a.f.width()-n.offset().left+a.f.offset().left+16,B.width(),1))),r.j(d))}var a=this;a.a=[];var b=a.input=h(i).hide();a.options=c;var d=a.f=h('<div class="tagbox-wrapper" />').click(function(a){var b=h(a.target).closest("input, .tagbox-token, .tagbox-wrapper");b.is(".tagbox-token")?h(a.target).is("a")?k(b.data("token")):f(b.data("token")):
p();n.focus()}).insertBefore(a.input),n=h('<input type="text" />').attr({autocomplete:b.attr("autocomplete"),spellcheck:b.attr("spellcheck"),autocapitalize:b.attr("autocapitalize"),placeholder:b.attr("placeholder")}).on("keyup keydown blur update change",o).on("keypress",function(a){if(13===a.keyCode&&n.val())return a.preventDefault(),t}).on("blur",function(){setTimeout(function(){a.i||r.hide()},50)}).on("focus",s).on("keydown",function(b){var d=n.val().length==n[0].selectionStart,i=0===n[0].selectionEnd,
g=b.keyCode;if(37===g){if(m)return m===a.a[0]?p():f(a.a[a.a.indexOf(m)-1]),t;i&&a.a.length&&f(a.a[a.a.length-1])}if(39===g){if(m)return m===a.a[a.a.length-1]?p():f(a.a[a.a.indexOf(m)+1]),t;d&&a.a.length&&f(a.a[0])}if(m&&(46===g||8===g))return k(m,8===g?-1:1),t;if(8===g&&i&&a.a.length)return f(a.a[a.a.length-1]),t;if(n.val()){if(38===g)return r.n(),t;if(40===g)return r.m(),t;if(39==g&&d||13==g||9==g){if(d=r.l())return e(d),t;if(c.allowNew)return e(c.createNew(n.val())),t}}else if(13==g)return t;if(a.a.length===
c.maxItems&&9!=b.keyCode)return n.val(""),t;setTimeout(s,10)}).appendTo(d),B=h("<span />").appendTo(d).css({position:"absolute",left:-1E5,width:"auto",display:"inline-block",whiteSpace:"nowrap",fontSize:b.css("fontSize"),fontFamily:b.css("fontFamily"),fontWeight:b.css("fontWeight"),fontVariant:b.css("fontVariant"),letterSpacing:b.css("letterSpacing")}),r=a.q=new F(a,c);r.b.appendTo(c.dropdownContainer);if(b.val())for(var y=c.items,z=b.val().split(c.delimiter),A,u=0;u<z.length;u+=1){A=t;for(var v=
0;v<y.length;v+=1)if(y[v][c.valueField]==z[u]){e(y[v]);A=l;break}!A&&c.allowNew&&e(c.createNew(z[u]))}var x=l;o(l);h(C).on("resize",function(){o(l)});a.k=e;var m}function D(i,c){var e=this,k=e.b=h('<div class="tagbox-token"><span></span><a>&times;</a></div>').data("token",e),g=c.tokenFormat;e.value="string"==typeof i?i:i[c.valueField];e.item=i;"string"==typeof g?("string"==typeof i&&(i={value:i}),k.children("span").html(g.replace(/\{\{([^}]*)\}\}/g,function(e,c){return i[c]}))):k.children("span").html(g(i));
e.remove=function(){k.data("token",null);k.remove();e.item=null;e.b=null};e.select=function(){k.addClass("selected")};e.d=function(){k.removeClass("selected")}}function F(i,c){function e(a,b){f&&f.d();s&&s.removeClass("selected");"number"!==typeof a&&(a=q.indexOf(a));0<=a?(f=q[a],f.select(),clearTimeout(o),b?o=setTimeout(function(){k(f.b)},80):k(f.b)):(f=t,s&&s.addClass("selected"));p=a}function k(a){var b=a.offset().top-j.offset().top;0>b?j.scrollTop(b+j.scrollTop()):b>j.innerHeight()-a.outerHeight()&&
j.scrollTop(b+j.scrollTop()-j.innerHeight()+a.outerHeight())}var g=this,f,p,q,j=g.b=h('<div class="tagbox-dropdown"><div class="list"></div></div>').css({maxHeight:c.maxHeight}).hide();if(c.allowNew)var s=h('<div class="tagbox-item new-item" />').prependTo(j);g.j=function(a){j.offset();var b=a.offset(),d=j.parent().offset();j.parent().is("body")&&(d={top:0,left:0});j.css({top:b.top-d.top+a.height()+1,left:b.left-d.left,width:a.outerWidth()})};g.show=function(){j.show()};g.hide=function(){j.hide()};
g.l=function(){if(f)return f.item};g.m=function(){p===q.length-1?c.allowNew||0===q.length?e(-1):e(0):e(p+1)};g.n=function(){0===p?c.allowNew?e(-1):e(q.length-1):(-1===p&&(p=q.length),e(p-1))};var o;g.o=function(a){j.find(".new-item").text(c.newText.replace(/\{\{txt\}\}/g,a))};g.p=function(a){j.find(".list").empty();q=[];if(0<a.length){for(var b=0;b<Math.min(a.length,c.maxListItems);b+=1){var d=new G(a[b],c);d.b.appendTo(j.find(".list"));d.b.on("mouseover",function(a){return function(){e(a,l)}}(d));
d.b.on("mousedown",function(){i.i=l}).on("mouseup",function(){i.i=t});d.b.on("click",function(a){return function(){i.k(a)}}(a[b]));q.push(d)}e(0)}else c.allowNew||h('<div class="tagbox-item empty"/>').text(c.emptyText).appendTo(j.find(".list")),e(-1);g.show()}}function G(i,c){var e=this.b=h('<div class="tagbox-item" />');c.itemClass&&e.addClass(c.itemClass);this.item=i;var k=c.rowFormat;"string"==typeof k?("string"==typeof i&&(i={value:i}),e.html(k.replace(/\{\{([^}]*)\}\}/g,function(e,c){return i[c]}))):
e.html(k(i));this.select=function(){e.addClass("selected")};this.d=function(){e.removeClass("selected")}}var E=function(){function i(a){return a.replace(/[\[\]\{\}\(\)\^\$\.\*\+\|]/g,function(a){return"\\"+a})}function c(a){return/[a-z]/.test(a)?f:/[A-Z]/.test(a)?g:/[0-9]/.test(a)?h:/[\/\-_\.]/.test(a)?q:j}function e(a,b,d){a=c(a);return s[a][c(b)]+0.4*s[a][c(d)]}function k(a,b,d){if(0===b.length)return 100*d/a.length;if(0===a.length||!a.slice(d).match(RegExp(("^.*"+i(b.split("").join("~~K~~"))+".*$").split("~~K~~").join(".*"),
"i")))return-1;for(var c=b.charAt(0),f=-1,g;d<a.length;d+=1)if(a.charAt(d).toLowerCase()===c.toLowerCase()){var j=k(a.substr(d),b.slice(1),1);if(-1!=j){var h=400/Math.max(1,d);0===a.substr(d).toLowerCase().indexOf(b.toLowerCase())&&(h+=3*b.length*b.length);h+=e(a.charAt(d),0===d?"/":a.charAt(d-1),d===a.length-1?"/":a.charAt(d+1));h+=j;if(h>f){f=h;g=[d];j=j.e||[];for(h=0;h<j.length;h+=1)g.push(j[h]+d)}}}return{c:f,valueOf:function(){return this.c},e:g}}var g=0,f=1,h=2,q=3,j=4,s=[[0,240,120,240,220],
[20,0,20,120,120],[140,140,0,140,140],[120,120,120,0,120],[120,120,120,160,0]],o=function(a,b){var d=RegExp("["+a+"]","g"),c={},e;lookup=function(a){return c[a]||a};for(e=0;e<a.length;e+=1)c[a.charAt(e)]=b.charAt(e);return function(a){return a.replace(d,lookup)}}("\u00e0\u00e1\u00e2\u00e3\u00e4\u00e7\u00e8\u00e9\u00ea\u00eb\u00ec\u00ed\u00ee\u00ef\u00f1\u00f2\u00f3\u00f4\u00f5\u00f6\u00f9\u00fa\u00fb\u00fc\u00fd\u00ff\u00c0\u00c1\u00c2\u00c3\u00c4\u00c7\u00c8\u00c9\u00ca\u00cb\u00cc\u00cd\u00ce\u00cf\u00d1\u00d2\u00d3\u00d4\u00d5\u00d6\u00d9\u00da\u00db\u00dc\u00dd",
"aaaaaceeeeiiiinooooouuuuyyAAAAACEEEEIIIINOOOOOUUUUY");return function(a,b,d){if("string"==typeof a)return k(o(a),o(b),0);var e={c:0,valueOf:function(){return this.c},e:{}},c;for(c in d)if(d.hasOwnProperty(c)&&a.hasOwnProperty(c)){var f=k(o(a[c]),o(b),0);e.c+=d[c]*f;e.e[c]=0<f?f.e:[]}return e}}();h.fn.tagbox=function(i){var c=h.extend({},{maxHeight:200,maxListItems:20,rowFormat:"{{name}}",tokenFormat:"{{name}}",valueField:"name",delimiter:",",allowDuplicates:t,createNew:function(c){return{name:c}},
allowNew:t,newText:"{{txt}}",emptyText:"Not Found",dropdownContainer:"body",maxItems:-1,autoShow:t},i);return this.each(function(){if(!h(this).data("tagbox")){var e=new x(this,c);h(this).data("tagbox",e)}})}})(jQuery,window);
