(function(k,H,B){function C(g,c){function b(x){x=new M(x,c);x.b.insertBefore(m);x.b.css("maxWidth",a.d.width());a.a.push(x);e.removeClass("empty");C&&m.val("");v(!0);p.hide();f||m.focus();d()}function s(c,b){c.remove();var f=a.a.indexOf(c);a.a.splice(f,1);0===a.a.length&&e.addClass("empty");c===q&&(q=B);d();v(!0);b&&(-1===b?h(a.a[f-1]):1===b&&h(a.a[f]));u()}function d(){for(var x=[],b=0;b<a.a.length;b+=1)x.push(a.a[b].value);l.val(x.join(c.delimiter));l.trigger("change")}function h(a){q&&q.l();q!==
a?(q=a,a.select()):q=B}function t(){q&&(q.l(),q=B)}function w(){var a=c.searchIn;"string"==typeof a&&(a=[a]);if(k.isArray(a)){for(var b={},f=0;f<a.length;f+=1)b[a[f]]=10;return b}return a}function n(c){for(var b=0;b<a.a.length;b+=1)if(a.a[b].item===c)return!0;return!1}function u(){clearTimeout(I);I=setTimeout(y,20)}function y(){var b=a.items,f=[],r=m.val(),l=w();e.removeClass("invalid");if(a.a.length===c.maxItems)p.hide(),m.removeAttr("placeholder");else if(m.attr("placeholder",J),""!==r||c.autoShow){if(""!==
r){for(var d=0;d<b.length;d+=1){var g={item:b[d],h:N(b[d],r,l)};0<g.h&&(c.allowDuplicates||!n(g.item))&&f.push(g)}f=f.sort(function(a,b){return b.h-a.h});for(d=0;d<f.length;d+=1)f[d]=f[d].item}else for(d=0;d<b.length;d+=1)!c.allowDuplicates&&n(b[d])||f.push(b[d]);p.t(f);p.s(r);p.m(e)}else p.hide()}function v(b){D||a.k==m.val()&&!0!==b||(e.toggleClass("full",a.a.length===c.maxItems),t(),a.k=m.val(),K.text(a.k),m.width(0),m.width(Math.min(e.width()-5,Math.max(e.width()-m.offset().left+e.offset().left+
5,K.width(),1))),p.m(e))}function r(){D||(D=!0,a.d.parent()&&a.d.remove(),a.input.parent()&&a.input.remove(),p.remove(),k(H).unbind("resize."+L),l=e=p=a.input=a.d=a.o=null)}var a=this;a.a=[];var f=!0;document.activeElement===g&&(f=!1);var l=a.input=k(g).hide();a.options=c;var e=a.d=k('<div class="tagbox-wrapper empty" />').click(function(a){var b=k(a.target).closest("input, .tagbox-token, .tagbox-wrapper");b.is(".tagbox-token")?k(a.target).is("a")?s(b.data("token")):h(b.data("token")):t();m.focus()}).insertBefore(a.input);
c.className&&e.addClass(c.className);l.on("invalid",function(b){b.preventDefault();a.d.addClass("invalid")});var J=l.attr("placeholder"),m=k('<input type="text" />').attr({autocomplete:l.attr("autocomplete"),spellcheck:l.attr("spellcheck"),autocapitalize:l.attr("autocapitalize"),placeholder:J}).on("keyup keydown blur update change",v).on("keypress",function(a){if(13===a.keyCode&&m.val())return a.preventDefault(),!1}).on("blur",function(){setTimeout(function(){a.e||p.hide();e.removeClass("focus")},
20);l.triggerHandler("blur")}).on("keydown",function(f){var d=m.val().length==m[0].selectionStart,r=0===m[0].selectionEnd,e=f.keyCode,l=!1;if(f.ctrlKey||f.metaKey)l=!0;if(37===e){if(q)return q===a.a[0]?t():h(a.a[a.a.indexOf(q)-1]),l;r&&a.a.length&&h(a.a[a.a.length-1])}if(39===e){if(q)return q===a.a[a.a.length-1]?t():h(a.a[a.a.indexOf(q)+1]),l;d&&a.a.length&&h(a.a[0])}if(q&&(46===e||8===e))return s(q,8===e?-1:1),l;if(8===e&&r&&a.a.length)return h(a.a[a.a.length-1]),l;if(p.visible){if(38===e)return p.r(),
l;if(40===e)return p.q(),l;if(39==e&&d||13==e||9==e)return p.visible&&((f=p.p())?b(f):c.allowNew&&m.val()&&b(c.createNew(m.val()))),l}else if(m.val()&&13==e)return l;if(a.a.length===c.maxItems&&9!=f.keyCode)return m.val(""),l;setTimeout(u,10)}).on("focus",function(){e.addClass("focus");l.triggerHandler("focus");u()}).appendTo(e);a.focus=function(){m.focus()};var K=k("<span />").appendTo(e).css({position:"absolute",left:-1E5,width:"auto",display:"inline-block",whiteSpace:"nowrap",fontSize:l.css("fontSize"),
fontFamily:l.css("fontFamily"),fontWeight:l.css("fontWeight"),fontVariant:l.css("fontVariant"),letterSpacing:l.css("letterSpacing")}),p=a.o=new O(a,c);p.b.appendTo(c.dropdownContainer);a.items=c.items;if(l.val())for(var E=a.items,F=l.val().split(c.delimiter),G,z=0;z<F.length;z+=1){G=!1;for(var A=0;A<E.length;A+=1)if(E[A][c.valueField]==F[z]){b(E[A]);G=!0;break}!G&&c.allowNew&&b(c.createNew(F[z]))}var C=!0,L=Math.random().toString().slice(2);v(!0);k(H).on("resize."+L,function(){v(!0)});setTimeout(function(){v(!0);
p.b.parent().length||p.b.appendTo(c.dropdownContainer)},500);a.j=b;var q,I,f=!1,D;l.on("tagbox_destroy",r);e.on("tagbox_destroy",r)}function M(g,c){var b=this,s=b.b=k('<div class="tagbox-token"><span></span><a>&times;</a></div>').data("token",b),d=c.tokenFormat;b.value="string"==typeof g?g:g[c.valueField];b.item=g;"string"==typeof d?("string"==typeof g&&(g={value:g}),s.children("span").html(d.replace(/\{\{([^}]*)\}\}/g,function(b,c){return g[c]}))):s.children("span").html(d(g));b.remove=function(){s.data("token",
null);s.remove();b.item=null;b.b=null};b.select=function(){s.addClass("selected")};b.l=function(){s.removeClass("selected")}}function O(g,c){function b(a){h&&k(h).removeClass("selected");u&&u.removeClass("selected");"number"!==typeof a&&(a=w.indexOf(a));if(0<=a){h=w[a];k(h).addClass("selected");clearTimeout(y);var b=h;clearTimeout(v);r=b;v=setTimeout(s,10)}else h=!1,u&&u.addClass("selected");t=a}function s(){var a=k(r),b=a.offset().top-n.offset().top;0>b?n.scrollTop(b+n.scrollTop()):b>n.innerHeight()-
a.outerHeight()&&n.scrollTop(b+n.scrollTop()-n.innerHeight()+a.outerHeight())}var d=this,h,t,w,n=d.b=k('<div class="tagbox-dropdown"><div class="tagbox-list"></div></div>').css({maxHeight:c.maxHeight}).on("mousedown",function(){g.e=!0}).on("mouseup",function(){g.e=!1}).on("mousemove",function(a){a=k(a.target).closest(".tagbox-item");a.length&&b(a[0])}).on("click",".tagbox-item:not(.new-item)",function(a){a=k(a.target).closest(".tagbox-item");a.length&&g.j(a[0].i)}).hide();if(c.allowNew)var u=k('<div class="tagbox-item new-item" />').prependTo(n).on("mousedown",
function(){g.e=!0}).on("mouseup",function(){g.e=!1}).on("click",function(){g.j(c.createNew(d.g))});d.remove=function(){d.b.remove()};d.m=function(a){if(n.parent().length){n.offset();var b=a.offset(),c=n.parent().offset();n.parent().is("body")&&(c={top:0,left:0});n.css({top:b.top-c.top+a.height()+1,left:b.left-c.left,width:a.outerWidth()})}};d.show=function(){n.show();d.visible=!0};d.hide=function(){n.hide();d.visible=!1};d.p=function(){if(h)return h.i};d.q=function(){t===w.length-1?c.allowNew&&d.g||
0===w.length?b(-1):b(0):b(t+1)};d.r=function(){0===t?c.allowNew&&d.g?b(-1):b(w.length-1):(-1===t&&(t=w.length),b(t-1))};var y,v,r;d.s=function(a){u&&((d.g=a)?u.show().text(c.newText.replace(/\{\{txt\}\}/g,a)):u.hide())};d.t=function(a){n.find(".tagbox-list").empty();w=[];var f=n.find(".tagbox-list")[0];if(0<a.length){for(var r=function(b){b=P(a[b],c);f.appendChild(b);w.push(b)},e=0;e<Math.min(50,a.length,c.maxListItems);)r(e++);50===e&&setTimeout(function(){for(;e<Math.min(a.length,c.maxListItems);)r(e++)},
20);b(0)}else c.allowNew||k('<div class="tagbox-item empty"/>').text(c.emptyText).appendTo(n.find(".tagbox-list")),b(-1);d.show()}}function P(g,c){var b=document.createElement("div");b.className="tagbox-item"+(c.itemClass?" "+c.itemClass:"");b.i=g;var k=c.rowFormat;"string"==typeof k?("string"==typeof g&&(g={value:g}),b.innerHTML=k.replace(/\{\{([^}]*)\}\}/g,function(b,c){return g[c]})):b.innerHTML=k(g);return b}var N=function(){function g(b){return b.replace(/[\[\]\{\}\(\)\^\$\.\*\+\|]/g,function(a){return"\\"+
a})}function c(b){return/[a-z]/.test(b)?t:/[A-Z]/.test(b)?h:/[0-9]/.test(b)?w:/[\/\-_\.]/.test(b)?n:u}function b(b,a,f){b=c(b);return y[b][c(a)]+0.4*y[b][c(f)]}function k(c,a,f){if(0===a.length)return 100*f/c.length;if(0===c.length||!c.slice(f).match(RegExp(("^.*"+g(a.split("").join("~~K~~"))+".*$").split("~~K~~").join(".*"),"i")))return-1;for(var d=a.charAt(0),e=-1,n;f<c.length;f+=1)if(c.charAt(f).toLowerCase()===d.toLowerCase()){var m=k(c.substr(f),a.slice(1),1);if(-1!=m){var h=400/Math.max(1,f);
0===c.substr(f).toLowerCase().indexOf(a.toLowerCase())&&(h+=3*a.length*a.length);h+=b(c.charAt(f),0===f?"/":c.charAt(f-1),f===c.length-1?"/":c.charAt(f+1));h+=m;if(h>e)for(e=h,n=[f],m=m.f||[],h=0;h<m.length;h+=1)n.push(m[h]+f)}}return{c:e,valueOf:function(){return this.c},f:n}}function d(b,a){return k(v(b),v(a),0)}var h=0,t=1,w=2,n=3,u=4,y=[[0,240,120,240,220],[20,0,20,120,120],[140,140,0,140,140],[120,120,120,0,120],[120,120,120,160,0]],v=function(b,a){var c=RegExp("["+b+"]","g"),d={},e;lookup=function(a){return d[a]||
a};for(e=0;e<b.length;e+=1)d[b.charAt(e)]=a.charAt(e);return function(a){return a.replace(c,lookup)}}("\u00e0\u00e1\u00e2\u00e3\u00e4\u00e7\u00e8\u00e9\u00ea\u00eb\u00ec\u00ed\u00ee\u00ef\u00f1\u00f2\u00f3\u00f4\u00f5\u00f6\u00f9\u00fa\u00fb\u00fc\u00fd\u00ff\u00c0\u00c1\u00c2\u00c3\u00c4\u00c7\u00c8\u00c9\u00ca\u00cb\u00cc\u00cd\u00ce\u00cf\u00d1\u00d2\u00d3\u00d4\u00d5\u00d6\u00d9\u00da\u00db\u00dc\u00dd","aaaaaceeeeiiiinooooouuuuyyAAAAACEEEEIIIINOOOOOUUUUY");return function(b,a,c){if("string"==
typeof b)return d(b,a);var g={c:0,valueOf:function(){return this.c},f:{}},e;for(e in c)if(c.hasOwnProperty(e)&&b.hasOwnProperty(e)){var h=d(b[e],a);g.c+=c[e]*h;g.f[e]=0<h?h.f:[]}return g}}();k.n=function(g){return function(c){var b,s,d;for(d=0;null!=(s=c[d]);d++)try{(b=k.u(s,"events"))&&b.tagbox_destroy&&k(s).triggerHandler("tagbox_destroy")}catch(h){}g(c)}}(k.n);k.fn.tagbox=function(g){var c=k.extend({},{maxHeight:200,maxListItems:20,rowFormat:"{{value}}",tokenFormat:"{{value}}",valueField:"value",
searchIn:["value"],delimiter:",",allowDuplicates:!1,createNew:function(b){return{value:b}},allowNew:!1,newText:"{{txt}}",emptyText:"Not Found",dropdownContainer:"body",maxItems:-1,autoShow:!1},g);return this.each(function(){if(!k(this).data("tagbox")){var b=new C(this,c);k(this).data("tagbox",b)}})}})(jQuery,window);
