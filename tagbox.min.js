var j=!0,r=!1;
(function(g,B,u){function C(e,c){function b(o){o=new D(o,c);o.a.insertBefore(k);a.b.push(o);k.val("");l(j);h.hide();q()}function f(o,c){o.remove();var b=a.b.indexOf(o);a.b.splice(b,1);o===i&&(i=u);q();l(j);c&&(-1===c?p(a.b[b-1]):1===c&&p(a.b[b]));s()}function q(){for(var o=[],b=0;b<a.b.length;b+=1)o.push(a.b[b].value);n.val(o.join(c.delimiter))}function p(a){i&&i.f();i!==a?(i=a,a.select()):i=u}function t(){i&&(i.f(),i=u)}function E(){var a=c.searchIn;"string"==typeof a&&(a=[a]);if(g.isArray(a)){for(var b={},
d=0;d<a.length;d+=1)b[a[d]]=10;return b}return a}function x(b){for(var c=0;c<a.b.length;c+=1)if(a.b[c].item===b)return j;return r}function s(){var a=c.items,b=[],d=k.val(),n=E();if(""===d&&!c.autoShow)h.hide();else{if(""!==d){for(var f=0;f<a.length;f+=1){var e={item:a[f],i:F(a[f],d,n)};0<e.i&&(c.allowDuplicates||!x(e.item))&&b.push(e)}b=b.sort(function(a,b){return b.i-a.i});for(f=0;f<b.length;f+=1)b[f]=b[f].item}else for(f=0;f<a.length;f+=1)(c.allowDuplicates||!x(a[f]))&&b.push(a[f]);h.s(b);h.r(d)}}
function l(b){a.k==k.val()&&b!==j||(t(),a.k=k.val(),A.text(a.k),k.width(0),k.width(Math.min(a.j.width()-16,Math.max(a.j.width()-k.offset().left+a.j.offset().left-16,A.width(),1))),h.t(d))}var a=this;a.b=[];var n=a.input=g(e).hide();a.options=c;var d=a.j=g('<div class="tagbox-wrapper" />').click(function(a){var b=g(a.target).closest("input, .tagbox-token, .tagbox-wrapper");b.is(".tagbox-token")?g(a.target).is("a")?f(b.data("token")):p(b.data("token")):t();k.focus()}).insertBefore(a.input),k=g('<input type="text" />').bind("keyup keydown blur update change",
l).bind("blur",function(){setTimeout(function(){a.l||h.hide()},50)}).bind("focus",s).bind("keydown",function(d){var n=k.val().length==k[0].selectionStart,e=0===k[0].selectionEnd;if(37===d.keyCode){if(i)return i===a.b[0]?t():p(a.b[a.b.indexOf(i)-1]),r;e&&a.b.length&&p(a.b[a.b.length-1])}if(39===d.keyCode){if(i)return i===a.b[a.b.length-1]?t():p(a.b[a.b.indexOf(i)+1]),r;n&&a.b.length&&p(a.b[0])}if(i&&(46===d.keyCode||8===d.keyCode))return f(i,8===d.keyCode?-1:1),r;if(8===d.keyCode&&e&&a.b.length)return p(a.b[a.b.length-
1]),r;if(k.val()){if(38===d.keyCode)return h.q(),r;if(40===d.keyCode)return h.p(),r;if(39==d.keyCode&&n||13==d.keyCode||9==d.keyCode){if(d=h.n())return b(d),r;if(c.allowNew)return b(c.createNew(k.val())),r}}else if(13==d.keyCode)return r;if(a.b.length===c.maxItems)return k.val(""),r;setTimeout(s,10)}).appendTo(d),A=g("<span />").appendTo(d).css({position:"absolute",left:-99999,width:"auto",display:"inline-block",whiteSpace:"nowrap",fontSize:n.css("fontSize"),fontFamily:n.css("fontFamily"),fontWeight:n.css("fontWeight"),
fontVariant:n.css("fontVariant"),letterSpacing:n.css("letterSpacing")}),h=a.u=new G(a,c);h.a.appendTo(c.dropdownContainer);if(n.val())for(var y=c.items,m=n.val().split(c.delimiter),z,v=0;v<m.length;v+=1){z=r;for(var w=0;w<y.length;w+=1)if(y[w][c.valueField]==m[v]){b(y[w]);z=j;break}!z&&c.allowNew&&b(c.createNew(m[v]))}l(j);g(B).bind("resize",function(){l(j)});a.m=b;var i}function D(e,c){var b=this.a=g('<div class="tagbox-token"><span></span><a>&times;</a></div>').data("token",this),f=c.tokenFormat;
"string"==typeof f?b.children("span").html(f.replace(/\{\{([^}]*)\}\}/g,function(b,c){return e[c]})):b.children("span").html(f(e));this.value=e[c.valueField];this.item=e;this.remove=function(){this.a.data("token",null);this.a.remove();this.a=this.item=null};this.select=function(){this.a.addClass("selected")};this.f=function(){this.a.removeClass("selected")}}function G(e,c){this.a=g('<div class="tagbox-dropdown"><div class="list"></div></div>').css({maxHeight:c.maxHeight}).hide();c.allowNew&&(this.h=
g('<div class="tagbox-item new-item" />').prependTo(this.a));this.t=function(b){this.a.offset();var c=b.offset(),e=this.a.parent().offset();this.a.parent().is("body")&&(e={top:0,left:0});this.a.css({top:c.top-e.top+b.height()+1,left:c.left-e.left,width:b.outerWidth()})};this.show=function(){this.a.show()};this.hide=function(){this.a.hide()};this.n=function(){if(this.d)return this.d.item};this.p=function(){this.selectedIndex===this.rows.length-1?c.allowNew||this.rows.length===0?this.c(-1):this.c(0):
this.c(this.selectedIndex+1)};this.q=function(){if(this.selectedIndex===0)c.allowNew?this.c(-1):this.c(this.rows.length-1);else{if(this.selectedIndex===-1)this.selectedIndex=this.rows.length;this.c(this.selectedIndex-1)}};this.c=function(b){this.d&&this.d.f();this.h&&this.h.removeClass("selected");typeof b!=="number"&&(b=this.rows.indexOf(b));if(b>=0){this.d=this.rows[b];this.d.select();this.o(this.d.a)}else{this.d=r;this.h&&this.h.addClass("selected")}this.selectedIndex=b};this.o=function(b){var c=
b.offset().top-this.a.offset().top-this.a.scrollTop();c<0?this.a.scrollTop(b.offset().top-this.a.offset().top):c>this.a.height()-b.height()&&this.a.scrollTop(c+this.a.scrollTop()-this.a.height()+b.height())};this.r=function(b){this.a.find(".new-item").text(c.newText.replace(/\{\{txt\}\}/g,b))};this.s=function(b){this.a.find(".list").empty();this.rows=[];if(b.length>0){for(var f=0;f<Math.min(b.length,c.maxListItems);f=f+1){var q=new H(b[f],c);q.a.appendTo(this.a.find(".list"));q.a.on("mouseover",function(b,
c){return function(){b.c(c)}}(this,q));q.a.on("mousedown",function(){e.l=j}).on("mouseup",function(){e.l=r});q.a.on("click",function(b){return function(){e.m(b)}}(b[f]));this.rows.push(q)}this.c(0)}else{c.allowNew||g('<div class="tagbox-item empty"/>').text(c.emptyText).appendTo(this.a.find(".list"));this.c(-1)}this.show()}}function H(e,c){this.a=g('<div class="tagbox-item" />');c.itemClass&&this.a.addClass(c.itemClass);this.item=e;var b=c.rowFormat;"string"==typeof b?this.a.html(b.replace(/\{\{([^}]*)\}\}/g,
function(b,c){return e[c]})):this.a.html(b(e));this.select=function(){this.a.addClass("selected")};this.f=function(){this.a.removeClass("selected")}}var F=function(){function e(a){return a.replace(/[\[\]\{\}\(\)\^\$\.\*\+\|]/g,function(a){return"\\"+a})}function c(a){return/[a-z]/.test(a)?p:/[A-Z]/.test(a)?g:/[0-9]/.test(a)?t:/[\/\-_\.]/.test(a)?u:x}function b(a,b,d){a=c(a);return s[a][c(b)]+0.4*s[a][c(d)]}function f(a,c,d){if(0===c.length)return 100*d/a.length;if(0===a.length||!a.slice(d).match(RegExp(("^.*"+
e(c.split("").join("~~K~~"))+".*$").split("~~K~~").join(".*"),"i")))return-1;for(var k=c.charAt(0),g=-1,h;d<a.length;d+=1)if(a.charAt(d).toLowerCase()===k.toLowerCase()){var l=f(a.substr(d),c.slice(1),1);if(-1!=l){var m=400/Math.max(1,d);0===a.substr(d).toLowerCase().indexOf(c.toLowerCase())&&(m+=3*c.length*c.length);m+=b(a.charAt(d),0===d?"/":a.charAt(d-1),d===a.length-1?"/":a.charAt(d+1));m+=l;if(m>g){g=m;h=[d];l=l.g||[];for(m=0;m<l.length;m+=1)h.push(l[m]+d)}}}return{e:g,valueOf:function(){return this.e},
g:h}}var g=0,p=1,t=2,u=3,x=4,s=[[0,240,120,240,220],[20,0,20,120,120],[140,140,0,140,140],[120,120,120,0,120],[120,120,120,160,0]],l=function(){var a=RegExp("[\u00e0\u00e1\u00e2\u00e3\u00e4\u00e7\u00e8\u00e9\u00ea\u00eb\u00ec\u00ed\u00ee\u00ef\u00f1\u00f2\u00f3\u00f4\u00f5\u00f6\u00f9\u00fa\u00fb\u00fc\u00fd\u00ff\u00c0\u00c1\u00c2\u00c3\u00c4\u00c7\u00c8\u00c9\u00ca\u00cb\u00cc\u00cd\u00ce\u00cf\u00d1\u00d2\u00d3\u00d4\u00d5\u00d6\u00d9\u00da\u00db\u00dc\u00dd]","g"),b={},c;lookup=function(a){return b[a]||
a};for(c=0;51>c;c+=1)b["\u00e0\u00e1\u00e2\u00e3\u00e4\u00e7\u00e8\u00e9\u00ea\u00eb\u00ec\u00ed\u00ee\u00ef\u00f1\u00f2\u00f3\u00f4\u00f5\u00f6\u00f9\u00fa\u00fb\u00fc\u00fd\u00ff\u00c0\u00c1\u00c2\u00c3\u00c4\u00c7\u00c8\u00c9\u00ca\u00cb\u00cc\u00cd\u00ce\u00cf\u00d1\u00d2\u00d3\u00d4\u00d5\u00d6\u00d9\u00da\u00db\u00dc\u00dd"[c]]="aaaaaceeeeiiiinooooouuuuyyAAAAACEEEEIIIINOOOOOUUUUY"[c];return function(b){return b.replace(a,lookup)}}();return function(a,b,c){if("string"==typeof a)return f(l(a),
l(b),0);var e={e:0,valueOf:function(){return this.e},g:{}},g;for(g in c)if(c.hasOwnProperty(g)&&a.hasOwnProperty(g)){var h=f(l(a[g]),l(b),0);e.e+=c[g]*h;e.g[g]=0<h?h.g:[]}return e}}();g.fn.tagbox=function(e){var c=g.extend({},{maxHeight:200,maxListItems:20,rowFormat:"{{name}}",tokenFormat:"{{name}}",valueField:"name",delimiter:",",allowDuplicates:r,createNew:function(b){return{name:b}},allowNew:r,newText:"{{txt}}",emptyText:"Not Found",dropdownContainer:"body",maxItems:-1,autoShow:r},e);return this.each(function(){var b=
new C(this,c);g(this).data("tagbox",b)})}})(jQuery,window);
